name: Publish to Qiita

on:
  push:
    branches:
      - main
    paths:
      - 'public/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Qiita CLI
        run: npm install @qiita/qiita-cli

      - name: Publish to Qiita
        env:
          QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }}
        run: npx qiita publish --all

      - name: Commit updated articles
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/
          git diff --staged --quiet || git commit -m "chore: Update Qiita article IDs"
          git push

      - name: Generate article URLs
        id: urls
        env:
          QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }}
        run: |
          # Get username from API using token
          QIITA_USERNAME=$(curl -s -H "Authorization: Bearer ${QIITA_TOKEN}" \
            "https://qiita.com/api/v2/authenticated_user" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')

          URLS=""
          for file in public/*.md; do
            if [ -f "$file" ] && [[ "$file" != *"_template"* ]]; then
              # Extract id and private from frontmatter
              ID=$(grep -m1 "^id:" "$file" | sed 's/id:[[:space:]]*//' | tr -d "'" | tr -d '"')
              PRIVATE=$(grep -m1 "^private:" "$file" | sed 's/private:[[:space:]]*//')
              TITLE=$(grep -m1 "^title:" "$file" | sed 's/title:[[:space:]]*//' | tr -d "'" | tr -d '"')

              if [ -n "$ID" ] && [ "$ID" != "null" ]; then
                if [ "$PRIVATE" = "true" ]; then
                  URL="https://qiita.com/${QIITA_USERNAME}/private/${ID}"
                else
                  URL="https://qiita.com/${QIITA_USERNAME}/items/${ID}"
                fi
                URLS="${URLS}\\n- ${TITLE}: ${URL}"
              fi
            fi
          done
          echo "urls=$URLS" >> $GITHUB_OUTPUT

      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ARTICLE_URLS: ${{ steps.urls.outputs.urls }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "{\"content\": \"✅ Qiitaに記事を同期しました\\n\\n**記事一覧**${ARTICLE_URLS}\\n\\nCommit: ${{ github.sha }}\"}"
          fi

      - name: Notify Discord (Failed)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "{\"content\": \"❌ Qiita同期に失敗しました\\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          fi
